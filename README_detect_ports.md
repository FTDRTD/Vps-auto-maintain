# 代理服务端口检测和防火墙配置脚本

## 🚨 重要提示

### 原始版本 `detect_ports.sh` 存在语法错误，会导致以下错误：

```
unexpected EOF while looking for matching `''
```

**请使用修复版本 `detect_ports_repair.sh`**

## 文件说明

项目包含四个版本的脚本：

### 1. `detect_ports.sh` - 原始版本（有语法错误）
- 基础的端口检测功能

### 2. `detect_ports_clean.sh` - 增强版本
- 完整的配置文件解析
- 智能进程检测
- 详细的调试信息

### 3. `detect_ports_fixed.sh` - 修复版本
- 修复端口误匹配问题
- 精确的进程识别
- 避免与其他代理软件冲突
- 包含所有增强功能

### 4. `detect_ports_repair.sh` - **修复版本 ⭐推荐**
- 修复原始版本语法错误
- 包含所有增强功能和修复

## 使用方法

### 推荐使用修复版本：

```bash
# 下载脚本
wget https://github.com/FTDRTD/Vps-auto-maintain/raw/main/detect_ports_repair.sh

# 运行脚本
sudo bash detect_ports_repair.sh --token YOUR_TOKEN --chat-id YOUR_ID
```

## 检测逻辑

修复版本的检测顺序：

1. **进程端口检测**：检查 `sing-box` 进程正在监听的端口
2. **配置文件解析**：从 `/etc/sing-box/config.json` 等配置文件读取端口
3. **智能扫描**：扫描所有监听端口，精确识别 Sing-box 进程
4. **防火墙配置**：自动为检测到的端口配置 TCP/UDP 规则

## 精确匹配条件

### ✅ 识别为 Sing-box 的条件：
- 进程名完全为 `sing-box` 或 `sb`
- 命令行包含 `/etc/sing-box` 路径
- 端口为已知 Sing-box 端口（36479, 46500）

### ❌ 不识别为 Sing-box 的条件：
- 其他代理软件的进程（如 xray）
- 不相关的系统进程
- 已知被其他代理软件使用的端口

## 系统要求

- Linux 操作系统
- `ss` 或 `netstat` 命令
- `jq` 命令（推荐，用于解析JSON配置）
- `curl` 命令（用于 Telegram 通知）
- `sudo` 权限

## 输出示例

### 修复后的正确输出：

```
------------------------------------------------------------
开始检测代理服务端口并配置防火墙
------------------------------------------------------------
🔍 检测防火墙类型: firewalld
🕒 系统时区: Etc/UTC
🕐 当前时间: 2025-09-16 12:14:07
✅ 检测到 Xray 运行端口: 11910 12544 36892 42722 50406 58403
🔍 正在检测 Sing-box 监听端口...
📄 解析配置文件: /etc/sing-box/conf/Hysteria2-36479.json
📋 从配置文件读取到端口: 36479
📄 解析配置文件: /etc/sing-box/conf/TUIC-46500.json
📋 从配置文件读取到端口: 46500
✅ 检测到 Sing-box 运行端口: 36479 46500
✅ 防火墙规则配置完成，已允许相关端口的 UDP/TCP 流量
```

## 参数选项

- `--no-notify`: 禁用 Telegram 通知
- `--token TOKEN`: Telegram Bot Token
- `--chat-id ID`: Telegram Chat ID

## 故障排除

### Sing-box 端口仍未检测到

1. **检查进程状态**：
   ```bash
   ps aux | grep sing-box
   ```

2. **检查端口监听**：
   ```bash
   ss -tlnp | grep -i sing
   ```

3. **检查配置文件**：
   ```bash
   cat /etc/sing-box/config.json | jq '.inbounds[]?.port'
   ```

4. **查看 Sing-box 日志**：
   ```bash
   journalctl -u sing-box -f
   ```

## 版本对比

| 功能 | 原始版本 | 增强版本 | 修复版本 | 修复版本(语法) |
|------|----------|----------|----------|----------|
| 基础检测 | ✅ | ✅ | ✅ | ✅ |
| 配置解析 | ❌ | ✅ | ✅ | ✅ |
| 调试信息 | ❌ | ✅ | ✅ | ✅ |
| 误匹配修复 | ❌ | ❌ | ✅ | ✅ |
| 语法错误修复 | ❌ | ❌ | ❌ | ✅ |
| 冲突避免 | ❌ | ❌ | ✅ | ✅ |
| 精确识别 | ❌ | ❌ | ✅ | ✅ |

## 安全注意事项

- 脚本只会为检测到的端口添加规则
- 建议定期检查防火墙配置
- 在生产环境中使用前请审核脚本逻辑

## 更新日志

### v4.0 - 修复版本(语法)
- ✅ 修复原始版本语法错误
- ✅ 包含所有增强功能和修复

### v3.0 - 修复版本
- ✅ 修复端口误匹配问题
- ✅ 添加精确进程识别
- ✅ 避免代理软件间冲突
- ✅ 包含所有增强功能

### v2.0 - 增强版本
- ✅ 添加配置文件解析功能
- ✅ 改进进程检测逻辑
- ✅ 增强调试信息输出
- ✅ 更好的错误处理

### v1.0 - 原始版本
- ✅ 基础端口检测功能
- ✅ 防火墙规则配置
- ✅ Telegram 通知支持